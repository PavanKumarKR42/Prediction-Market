<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=390, initial-scale=1.0" />
  <title>Crypto Price Betting</title>

  <!-- Farcaster Mini App Metadata -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://your-app.vercel.app/image.png",
    "button":{
      "title":"Crypto Betting",
      "action":{
        "type":"launch_frame",
        "name":"Crypto Price Betting",
        "url":"https://your-app.vercel.app",
        "splashImageUrl":"https://your-app.vercel.app/splash.png",
        "splashBackgroundColor":"#111111"
      }
    }
  }' />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      margin: 0;
      background: #0a0a0a;
      color: #fff;
      font-family: Inter, system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      max-width: 390px;
      margin-inline: auto;
      padding-bottom: 20px;
    }

    .header {
      width: 100%;
      padding: 16px;
      background: #111;
      border-bottom: 1px solid #222;
    }

    .wallet-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }

    .wallet-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .address {
      color: #ffd166;
      font-weight: 600;
    }

    .balance {
      color: #aaa;
    }

    .tabbar {
      display: flex;
      gap: 8px;
      width: 100%;
      padding: 12px;
    }

    .tabbar button {
      flex: 1;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #aaa;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
    }

    .tabbar button.active {
      background: #ffd166;
      color: #000;
      border-color: #ffd166;
    }

    .hidden { display: none; }

    .section {
      width: 100%;
      padding: 0 12px;
    }

    .wallet-actions {
      display: flex;
      gap: 8px;
      margin: 12px 0;
    }

    .btn {
      padding: 12px;
      background: #ffd166;
      color: #000;
      border: none;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
      font-size: 14px;
      flex: 1;
    }

    .btn:disabled {
      background: #444;
      color: #888;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
    }

    .btn-claim {
      background: #7ee027;
      color: #000;
    }

    .input-group {
      margin: 12px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      color: #aaa;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }

    .slots-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .slot-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 14px;
    }

    .claim-card {
      background: linear-gradient(135deg, #1a2a1a 0%, #1a1a1a 100%);
      border: 1px solid #3a5a3a;
    }

    .slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .token-name {
      font-size: 18px;
      font-weight: 800;
      color: #ffd166;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
    }

    .status-open {
      background: #2d5016;
      color: #7ee027;
    }

    .status-closed {
      background: #4a1e1e;
      color: #ff6b6b;
    }

    .status-settled {
      background: #2a3a4a;
      color: #64b5f6;
    }

    .status-won {
      background: #2d5016;
      color: #7ee027;
    }

    .status-lost {
      background: #4a1e1e;
      color: #ff6b6b;
    }

    .status-claimed {
      background: #3a3a2a;
      color: #ffd166;
    }

    .slot-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 12px 0;
      font-size: 13px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      color: #888;
      font-size: 11px;
      text-transform: uppercase;
    }

    .info-value {
      color: #fff;
      font-weight: 600;
    }

    .pools {
      display: flex;
      gap: 8px;
      margin: 12px 0;
    }

    .pool {
      flex: 1;
      padding: 10px;
      background: #0f0f0f;
      border-radius: 8px;
      text-align: center;
    }

    .pool-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .pool-value {
      font-size: 16px;
      font-weight: 700;
      color: #ffd166;
    }

    .bet-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .timer {
      text-align: center;
      padding: 8px;
      background: #0f0f0f;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 13px;
      color: #ffd166;
    }

    .toast {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 600;
      max-width: 360px;
      width: calc(100% - 24px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 9999;
    }

    .toast a {
      color: #ffd166;
      text-decoration: underline;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.25s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, 10px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 350px;
    }

    .modal-header {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 16px;
      color: #ffd166;
    }

    .bet-option {
      display: flex;
      gap: 8px;
      margin: 12px 0;
    }

    .bet-option button {
      flex: 1;
      padding: 12px;
      background: #2a2a2a;
      border: 2px solid #444;
      color: #fff;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .bet-option button.selected {
      background: #ffd166;
      color: #000;
      border-color: #ffd166;
    }

    .user-bet-info {
      text-align: center;
      font-size: 12px;
      color: #ffd166;
      margin: 8px 0;
      padding: 8px;
      background: #0f0f0f;
      border-radius: 6px;
    }

    .bet-hint {
      text-align: center;
      margin: 8px 0;
      padding: 8px;
      background: #0f0f0f;
      border-radius: 6px;
      font-size: 12px;
      color: #aaa;
    }

    .claim-stats {
      display: flex;
      justify-content: space-around;
      padding: 12px;
      background: #0f0f0f;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .claim-stat {
      text-align: center;
    }

    .claim-stat-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .claim-stat-value {
      font-size: 18px;
      font-weight: 800;
      color: #7ee027;
    }

    .claim-stat-value.lost {
      color: #ff6b6b;
    }

    .claim-stat-value.neutral {
      color: #ffd166;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .payout-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #0f0f0f;
      border-radius: 8px;
      margin: 8px 0;
    }

    .payout-label {
      font-size: 12px;
      color: #888;
    }

    .payout-value {
      font-size: 16px;
      font-weight: 800;
      color: #7ee027;
    }

    .slots-history {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #333;
    }

    .history-header {
      font-size: 14px;
      font-weight: 700;
      color: #888;
      margin-bottom: 12px;
      padding: 0 12px;
    }
  </style>
</head>
<body>

  <!-- Header with Wallet Info -->
  <div class="header">
    <div class="wallet-info">
      <div class="wallet-row">
        <span>Address:</span>
        <span class="address" id="walletAddress">Connecting...</span>
      </div>
      <div class="wallet-row">
        <span>Wallet Balance:</span>
        <span class="balance" id="walletBalance">-- ETH</span>
      </div>
      <div class="wallet-row">
        <span>Contract Balance:</span>
        <span class="balance" id="contractBalance">-- ETH</span>
      </div>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tabbar">
    <button id="tabWalletBtn" class="active">Wallet</button>
    <button id="tabBetBtn">Bet</button>
    <button id="tabClaimBtn">Claim</button>
  </div>

  <!-- Wallet Tab -->
  <section id="walletTab" class="section">
    <div class="wallet-actions">
      <button id="depositBtn" class="btn">Deposit</button>
      <button id="withdrawBtn" class="btn btn-secondary">Withdraw</button>
    </div>

    <div class="input-group hidden" id="depositInput">
      <label>Deposit Amount (min 0.0005 ETH)</label>
      <input type="number" id="depositAmount" placeholder="0.001" step="0.0001" min="0.0005" />
      <button id="confirmDepositBtn" class="btn" style="margin-top: 8px;">Confirm Deposit</button>
    </div>

    <div class="input-group hidden" id="withdrawInput">
      <label>Withdraw Amount</label>
      <input type="number" id="withdrawAmount" placeholder="0.001" step="0.0001" min="0" />
      <button id="confirmWithdrawBtn" class="btn btn-secondary" style="margin-top: 8px;">Confirm Withdraw</button>
    </div>
  </section>

  <!-- Betting Tab -->
  <section id="betTab" class="section hidden">
    <div id="slotsContainer" class="slots-container">
      <p style="text-align: center; color: #888;">Loading slots...</p>
    </div>
    <div class="slots-history hidden">
      <div class="history-header">üìú Recent Slots</div>
      <div id="recentSlotsContainer" class="slots-container"></div>
    </div>
  </section>

  <!-- Claim Tab -->
  <section id="claimTab" class="section hidden">
    <div class="claim-stats">
      <div class="claim-stat">
        <div class="claim-stat-label">Total Bets</div>
        <div class="claim-stat-value neutral" id="totalBets">0</div>
      </div>
      <div class="claim-stat">
        <div class="claim-stat-label">Won</div>
        <div class="claim-stat-value" id="wonBets">0</div>
      </div>
      <div class="claim-stat">
        <div class="claim-stat-label">Lost</div>
        <div class="claim-stat-value lost" id="lostBets">0</div>
      </div>
      <div class="claim-stat">
        <div class="claim-stat-label">To Claim</div>
        <div class="claim-stat-value" id="claimableCount">0</div>
      </div>
    </div>
    <div class="claim-stats" style="margin-bottom: 8px;">
      <div class="claim-stat">
        <div class="claim-stat-label">Total Winnings</div>
        <div class="claim-stat-value" id="totalWinnings">0 ETH</div>
      </div>
      <div class="claim-stat">
        <div class="claim-stat-label">Already Claimed</div>
        <div class="claim-stat-value neutral" id="totalClaimed">0 ETH</div>
      </div>
    </div>
    <div id="claimContainer" class="slots-container">
      <p style="text-align: center; color: #888;">Loading claims...</p>
    </div>
  </section>

  <!-- Bet Modal -->
  <div id="betModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Place Bet - BTC</div>
      
      <div class="bet-option">
        <button id="betAboveBtn">üìà Above</button>
        <button id="betBelowBtn">üìâ Below</button>
      </div>

      <div class="input-group">
        <label>Bet Amount (ETH)</label>
        <input type="number" id="betAmount" placeholder="0.001" step="0.0001" min="0.0001" />
      </div>

      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button id="cancelBetBtn" class="btn btn-secondary">Cancel</button>
        <button id="confirmBetBtn" class="btn">Place Bet</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Farcaster + wagmi -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    import {
      createConfig, connect, getAccount, getBalance, readContract, writeContract, watchContractEvent, http
    } from 'https://esm.sh/@wagmi/core';
    import { baseSepolia } from 'https://esm.sh/@wagmi/core/chains';
    import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';

    sdk.actions.ready({ disableNativeGestures: true }).then(async () => {
      console.log("Farcaster MiniApp ready");

      const hasPromptedAddApp = sessionStorage.getItem('hasPromptedAddApp');
      if (!hasPromptedAddApp) {
        try {
          await sdk.actions.addMiniApp();
          sessionStorage.setItem('hasPromptedAddApp', 'true');
        } catch (error) {
          sessionStorage.setItem('hasPromptedAddApp', 'true');
        }
      }
    }).catch(err => {
      console.error("SDK ready error:", err);
      showToast("Failed to initialize. Try reloading.");
    });

    // ‚ö†Ô∏è UPDATE YOUR CONTRACT ADDRESS HERE
    const CONTRACT_ADDRESS = '0x75447B88BCd68b10E5776d5883aE10BCfe322D4C';
    
    // ‚ö†Ô∏è PASTE YOUR CONTRACT ABI HERE
    const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_btcFeed","type":"address"},{"internalType":"address","name":"_ethFeed","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"string","name":"symbol","type":"string"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"above","type":"bool"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"string","name":"symbol","type":"string"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"payout","type":"uint256"}],"name":"Claimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"string","name":"symbol","type":"string"},{"indexed":false,"internalType":"int256","name":"startPrice","type":"int256"}],"name":"SlotCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"startTime","type":"uint256"},{"indexed":false,"internalType":"string","name":"symbol","type":"string"},{"indexed":false,"internalType":"int256","name":"targetPrice","type":"int256"}],"name":"SlotSettled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Withdraw","type":"event"},{"inputs":[],"name":"BETTING_WINDOW","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_DEPOSIT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SLOT_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"},{"internalType":"address","name":"","type":"address"}],"name":"bets","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"betAbove","type":"bool"},{"internalType":"bool","name":"claimed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"btcFeed","outputs":[{"internalType":"contract IPriceFeed","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"","type":"bytes"}],"name":"checkUpkeep","outputs":[{"internalType":"bool","name":"upkeepNeeded","type":"bool"},{"internalType":"bytes","name":"","type":"bytes"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"slotStartTime","type":"uint256"},{"internalType":"string","name":"symbol","type":"string"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"ethFeed","outputs":[{"internalType":"contract IPriceFeed","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastSlotTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"","type":"bytes"}],"name":"performUpkeep","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"slotStartTime","type":"uint256"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"bool","name":"betAbove","type":"bool"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"placeBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"}],"name":"slots","outputs":[{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"uint256","name":"targetTime","type":"uint256"},{"internalType":"uint256","name":"poolAbove","type":"uint256"},{"internalType":"uint256","name":"poolBelow","type":"uint256"},{"internalType":"int256","name":"startPrice","type":"int256"},{"internalType":"int256","name":"targetPrice","type":"int256"},{"internalType":"bool","name":"settled","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const TOKENS = ['BTC', 'ETH'];
    const SLOT_INTERVAL = 180; // 3 minutes
    const BETTING_WINDOW = 120; // 2 minutes

    const config = createConfig({
      chains: [baseSepolia],
      transports: { [baseSepolia.id]: http() }
    });

    let userAddress = null;
    let currentActiveTab = 'wallet';
    let timerInterval = null;
    let cachedSlots = new Map(); // Cache slot data
    
    const walletAddressEl = document.getElementById('walletAddress');
    const walletBalanceEl = document.getElementById('walletBalance');
    const contractBalanceEl = document.getElementById('contractBalance');
    const toastEl = document.getElementById('toast');
    const slotsContainer = document.getElementById('slotsContainer');
    const recentSlotsContainer = document.getElementById('recentSlotsContainer');
    const claimContainer = document.getElementById('claimContainer');
    const betModal = document.getElementById('betModal');

    async function autoConnectWallet() {
      try {
        walletAddressEl.textContent = 'Connecting...';
        await connect(config, {
          connector: farcasterMiniApp(),
          chainId: baseSepolia.id
        });
        userAddress = getAccount(config)?.address;
        if (userAddress) {
          walletAddressEl.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
          showToast(`‚úÖ Connected: ${userAddress.slice(0, 6)}‚Ä¶${userAddress.slice(-4)}`);
          await updateBalances();
        } else {
          throw new Error("No address returned");
        }
      } catch (err) {
        console.error("Auto connect failed:", err);
        walletAddressEl.textContent = 'Not Connected';
        showToast("‚ö†Ô∏è Connection failed. Open in Warpcast.", 5000);
      }
    }

    autoConnectWallet();

    const walletTab = document.getElementById('walletTab');
    const betTab = document.getElementById('betTab');
    const claimTab = document.getElementById('claimTab');
    
    document.getElementById('tabWalletBtn').onclick = () => switchTab('wallet');
    document.getElementById('tabBetBtn').onclick = () => switchTab('bet');
    document.getElementById('tabClaimBtn').onclick = () => switchTab('claim');

    function switchTab(tab) {
      currentActiveTab = tab;
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      walletTab.classList.add('hidden');
      betTab.classList.add('hidden');
      claimTab.classList.add('hidden');
      document.getElementById('tabWalletBtn').classList.remove('active');
      document.getElementById('tabBetBtn').classList.remove('active');
      document.getElementById('tabClaimBtn').classList.remove('active');

      if (tab === 'wallet') {
        walletTab.classList.remove('hidden');
        document.getElementById('tabWalletBtn').classList.add('active');
      } else if (tab === 'bet') {
        betTab.classList.remove('hidden');
        document.getElementById('tabBetBtn').classList.add('active');
        loadSlots();
      } else if (tab === 'claim') {
        claimTab.classList.remove('hidden');
        document.getElementById('tabClaimBtn').classList.add('active');
        loadClaims();
      }
    }

    function showToast(html, ms = 3500) {
      toastEl.innerHTML = html;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), ms);
    }

    async function updateBalances() {
      if (!userAddress) {
        walletBalanceEl.textContent = '-- ETH';
        contractBalanceEl.textContent = '-- ETH';
        return;
      }
      try {
        const balance = await getBalance(config, { address: userAddress });
        walletBalanceEl.textContent = `${parseFloat(balance.formatted).toFixed(4)} ETH`;
        const contractBal = await readContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'balances',
          args: [userAddress]
        });
        contractBalanceEl.textContent = `${(Number(contractBal) / 1e18).toFixed(4)} ETH`;
      } catch (e) {
        console.error('Balance update error:', e);
      }
    }

    const depositInput = document.getElementById('depositInput');
    const depositBtn = document.getElementById('depositBtn');
    const confirmDepositBtn = document.getElementById('confirmDepositBtn');

    depositBtn.onclick = () => {
      depositInput.classList.toggle('hidden');
      document.getElementById('withdrawInput').classList.add('hidden');
    };

    confirmDepositBtn.onclick = async () => {
      const amount = document.getElementById('depositAmount').value;
      if (!amount || parseFloat(amount) < 0.0005) {
        showToast('‚ùå Minimum deposit is 0.0005 ETH');
        return;
      }
      try {
        const txHash = await writeContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'deposit',
          value: BigInt(Math.floor(parseFloat(amount) * 1e18))
        });
        showToast(`‚è≥ Deposit pending... <a target="_blank" href="https://sepolia.basescan.org/tx/${txHash}">view</a>`, 5000);
        setTimeout(updateBalances, 3000);
      } catch (e) {
        showToast('‚ùå Deposit failed');
        console.error(e);
      }
    };

    const withdrawInput = document.getElementById('withdrawInput');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');

    withdrawBtn.onclick = () => {
      withdrawInput.classList.toggle('hidden');
      document.getElementById('depositInput').classList.add('hidden');
    };

    confirmWithdrawBtn.onclick = async () => {
      const amount = document.getElementById('withdrawAmount').value;
      if (!amount || parseFloat(amount) <= 0) {
        showToast('‚ùå Enter valid amount');
        return;
      }
      try {
        const txHash = await writeContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'withdraw',
          args: [BigInt(Math.floor(parseFloat(amount) * 1e18))]
        });
        showToast(`‚è≥ Withdraw pending... <a target="_blank" href="https://sepolia.basescan.org/tx/${txHash}">view</a>`, 5000);
        setTimeout(updateBalances, 3000);
      } catch (e) {
        showToast('‚ùå Withdraw failed');
        console.error(e);
      }
    };

    async function loadSlots() {
      try {
        const lastSlotTime = await readContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'lastSlotTime'
        });

        const currentSlotTime = Number(lastSlotTime);
        
        if (currentSlotTime === 0) {
          slotsContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">‚è≥ Waiting for first slot...<br><small style="color: #666;">Contract is initializing</small></p>';
          setTimeout(loadSlots, 5000);
          return;
        }

        // Always show current slot, even if closed
        const currentHtml = await Promise.all(TOKENS.map(token => renderSlotCard(currentSlotTime, token, true)));
        slotsContainer.innerHTML = currentHtml.join('');

        // Show recent slots (last 5)
        const recentSlots = [];
        for (let i = 1; i <= 5; i++) {
          const slotTime = currentSlotTime - (i * SLOT_INTERVAL);
          if (slotTime > 0) {
            recentSlots.push(slotTime);
          }
        }

        if (recentSlots.length > 0) {
          document.querySelector('.slots-history').classList.remove('hidden');
          const recentHtml = [];
          for (const slotTime of recentSlots) {
            const slotHtml = await Promise.all(TOKENS.map(token => renderSlotCard(slotTime, token, false)));
            recentHtml.push(...slotHtml);
          }
          recentSlotsContainer.innerHTML = recentHtml.join('');
        }

        // Start timer updates
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (currentActiveTab === 'bet') {
            updateAllTimers([currentSlotTime, ...recentSlots]);
          }
        }, 1000);

      } catch (e) {
        console.error('‚ùå Load slots error:', e);
        slotsContainer.innerHTML = `<p style="text-align: center; color: #f88;">Failed to load slots<br><small style="color: #666;">${e.message || 'Please check console'}</small></p>`;
      }
    }

    async function renderSlotCard(slotStartTime, symbol, isCurrent = true) {
      try {
        const cacheKey = `${slotStartTime}-${symbol}`;
        
        const slot = await readContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'slots',
          args: [BigInt(slotStartTime), symbol]
        });

        const [startTime, endTime, targetTime, poolAbove, poolBelow, startPrice, targetPrice, settled] = slot;
        
        if (Number(startTime) === 0) {
          return '';
        }

        cachedSlots.set(cacheKey, { slot, timestamp: Date.now() });

        const now = Math.floor(Date.now() / 1000);
        let status = 'settled';
        let statusClass = 'status-settled';
        
        if (!settled) {
          if (now < Number(endTime)) {
            status = 'open';
            statusClass = 'status-open';
          } else if (now < Number(targetTime)) {
            status = 'waiting';
            statusClass = 'status-closed';
          } else {
            status = 'ready';
            statusClass = 'status-closed';
          }
        }

        let userBet = null;
        let canClaim = false;
        let didWin = false;
        
        if (userAddress) {
          try {
            const bet = await readContract(config, {
              address: CONTRACT_ADDRESS,
              abi: CONTRACT_ABI,
              functionName: 'bets',
              args: [BigInt(slotStartTime), symbol, userAddress]
            });
            if (Number(bet[0]) > 0) {
              userBet = { amount: bet[0], betAbove: bet[1], claimed: bet[2] };
              if (settled) {
                didWin = bet[1] ? (targetPrice > startPrice) : (targetPrice < startPrice);
                canClaim = didWin && !bet[2];
              }
            }
          } catch (e) {}
        }

        const date = new Date(slotStartTime * 1000);
        const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        return `
          <div class="slot-card ${canClaim ? 'claim-card' : ''}">
            <div class="slot-header">
              <div class="token-name">${symbol} ${!isCurrent ? `<small style="font-size: 11px; color: #666;">${timeStr}</small>` : ''}</div>
              <div class="status-badge ${statusClass}">${status.toUpperCase()}</div>
            </div>

            <div class="slot-info">
              <div class="info-item">
                <div class="info-label">Start Price</div>
                <div class="info-value">${(Number(startPrice) / 1e8).toFixed(2)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Final Price ${settled ? '‚úÖ' : '‚è≥'}</div>
                <div class="info-value">${settled ? (Number(targetPrice) / 1e8).toFixed(2) : 'TBD'}</div>
              </div>
            </div>

            ${!settled && status === 'open' ? `<div class="bet-hint">
              üí° Bet if final price will be above or below ${(Number(startPrice) / 1e8).toFixed(2)}
            </div>` : ''}

            ${!settled && status === 'waiting' ? `<div class="bet-hint">
              üïê Betting closed. Waiting for settlement...
            </div>` : ''}

            ${!settled && status === 'ready' ? `<div class="bet-hint">
              ‚è≥ Ready to settle. Keeper will process soon...
            </div>` : ''}

            <div class="pools">
              <div class="pool">
                <div class="pool-label">üìà Above</div>
                <div class="pool-value">${(Number(poolAbove) / 1e18).toFixed(4)}</div>
              </div>
              <div class="pool">
                <div class="pool-label">üìâ Below</div>
                <div class="pool-value">${(Number(poolBelow) / 1e18).toFixed(4)}</div>
              </div>
            </div>

            <div class="timer" id="timer-${slotStartTime}-${symbol}">--:--</div>

            ${userBet ? `<div class="user-bet-info">
              Your bet: ${(Number(userBet.amount) / 1e18).toFixed(4)} ETH ${userBet.betAbove ? 'üìà Above' : 'üìâ Below'}
            </div>` : ''}

            <div class="bet-controls">
              ${!settled && status === 'open' && !userBet ? 
                `<button class="btn" onclick="window.openBetModal('${symbol}', ${slotStartTime})">Place Bet</button>` : 
                ''}
              
              ${userBet && !settled && status === 'open' ? 
                `<div style="text-align: center; color: #ffd166; font-size: 12px; padding: 8px; background: #0f0f0f; border-radius: 6px;">
                  ‚úÖ Bet placed! Waiting for settlement...
                </div>` : 
                ''}

              ${canClaim ? 
                `<div style="text-align: center; margin: 8px 0; padding: 12px; background: linear-gradient(135deg, #2d5016 0%, #1a3010 100%); border-radius: 10px; border: 2px solid #7ee027;">
                  <div style="font-size: 18px; font-weight: 800; color: #7ee027; margin-bottom: 8px;">üéâ YOU WON! üéâ</div>
                  <button class="btn btn-claim" onclick="window.claimReward(${slotStartTime}, '${symbol}')">Claim Your Reward</button>
                </div>` : 
                ''}
              
              ${settled && userBet && !didWin && !userBet.claimed ? 
                `<div style="text-align: center; margin: 8px 0; padding: 12px; background: linear-gradient(135deg, #4a1e1e 0%, #2a1010 100%); border-radius: 10px; border: 2px solid #ff6b6b;">
                  <div style="font-size: 18px; font-weight: 800; color: #ff6b6b; margin-bottom: 4px;">üíî YOU LOST</div>
                  <div style="font-size: 12px; color: #aaa;">Better luck next time!</div>
                </div>` : 
                ''}
              
              ${settled && userBet && userBet.claimed ? 
                `<div style="text-align: center; color: #ffd166; font-size: 12px; padding: 8px; background: #0f0f0f; border-radius: 6px;">
                  ‚úÖ Reward already claimed
                </div>` : 
                ''}
            </div>
          </div>
        `;
      } catch (e) {
        console.error(`Error loading ${symbol} at ${slotStartTime}:`, e);
        return '';
      }
    }

    async function updateAllTimers(slotTimes) {
      for (const slotTime of slotTimes) {
        for (const token of TOKENS) {
          const timerEl = document.getElementById(`timer-${slotTime}-${token}`);
          if (!timerEl) continue;

          try {
            const cacheKey = `${slotTime}-${token}`;
            let slot;

            if (cachedSlots.has(cacheKey)) {
              const cached = cachedSlots.get(cacheKey);
              if (Date.now() - cached.timestamp < 5000) {
                slot = cached.slot;
              }
            }

            if (!slot) {
              slot = await readContract(config, {
                address: CONTRACT_ADDRESS,
                abi: CONTRACT_ABI,
                functionName: 'slots',
                args: [BigInt(slotTime), token]
              });
              cachedSlots.set(cacheKey, { slot, timestamp: Date.now() });
            }

            const [startTime, endTime, targetTime, , , , , settled] = slot;
            
            if (Number(startTime) === 0) {
              timerEl.textContent = '‚è≥ Slot not created';
              continue;
            }

            const now = Math.floor(Date.now() / 1000);

            if (settled) {
              timerEl.textContent = '‚úÖ Settled';
              continue;
            }

            if (now < Number(endTime)) {
              const remaining = Number(endTime) - now;
              const mins = Math.floor(remaining / 60);
              const secs = remaining % 60;
              timerEl.textContent = `‚è±Ô∏è Betting closes in ${mins}:${secs.toString().padStart(2, '0')}`;
            } else if (now < Number(targetTime)) {
              const remaining = Number(targetTime) - now;
              const mins = Math.floor(remaining / 60);
              const secs = remaining % 60;
              timerEl.textContent = `üïê Settlement in ${mins}:${secs.toString().padStart(2, '0')}`;
            } else {
              timerEl.textContent = '‚è≥ Awaiting settlement...';
            }
          } catch (e) {
            timerEl.textContent = '--:--';
          }
        }
      }
    }

    let isLoadingClaims = false;
    let lastClaimsLoad = 0;

    async function loadClaims(forceReload = false) {
      // Prevent loading if already loading
      if (isLoadingClaims && !forceReload) {
        return;
      }

      // Don't reload if loaded within last 10 seconds (unless forced)
      const now = Date.now();
      if (!forceReload && now - lastClaimsLoad < 10000) {
        return;
      }

      if (!userAddress) {
        claimContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîå</div><p>Please connect wallet first</p></div>';
        document.getElementById('totalBets').textContent = '0';
        document.getElementById('wonBets').textContent = '0';
        document.getElementById('lostBets').textContent = '0';
        document.getElementById('claimableCount').textContent = '0';
        document.getElementById('totalWinnings').textContent = '0 ETH';
        document.getElementById('totalClaimed').textContent = '0 ETH';
        return;
      }

      try {
        isLoadingClaims = true;
        if (forceReload) {
          claimContainer.innerHTML = '<p style="text-align: center; color: #888;">Loading claims...</p>';
        }
        
        const lastSlotTime = await readContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'lastSlotTime'
        });

        const currentTimestamp = Number(lastSlotTime);
        const claims = [];
        let totalWinnings = 0;
        let totalClaimed = 0;
        let claimableCount = 0;
        let wonCount = 0;
        let lostCount = 0;

        // Look back 100 slots (5 hours) - load in parallel for speed
        const slotPromises = [];
        for (let i = 0; i < 100; i++) {
          const timestamp = currentTimestamp - (i * SLOT_INTERVAL);
          if (timestamp <= 0) break;
          
          for (const token of TOKENS) {
            slotPromises.push(checkSlotForBet(timestamp, token));
          }
        }

        const results = await Promise.allSettled(slotPromises);
        
        for (const result of results) {
          if (result.status === 'fulfilled' && result.value) {
            claims.push(result.value);
            
            if (result.value.settled) {
              if (result.value.didWin) {
                wonCount++;
                const payout = result.value.payout;
                if (!result.value.bet.claimed) {
                  totalWinnings += payout / 1e18;
                  claimableCount++;
                } else {
                  totalClaimed += payout / 1e18;
                }
              } else {
                lostCount++;
              }
            }
          }
        }

        // Sort by timestamp (newest first)
        claims.sort((a, b) => b.timestamp - a.timestamp);

        document.getElementById('totalBets').textContent = claims.length;
        document.getElementById('wonBets').textContent = wonCount;
        document.getElementById('lostBets').textContent = lostCount;
        document.getElementById('claimableCount').textContent = claimableCount;
        document.getElementById('totalWinnings').textContent = `${totalWinnings.toFixed(4)} ETH`;
        document.getElementById('totalClaimed').textContent = `${totalClaimed.toFixed(4)} ETH`;

        if (claims.length === 0) {
          claimContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No bets found</p><small style="color: #666;">Place some bets first!</small></div>';
          lastClaimsLoad = now;
          isLoadingClaims = false;
          return;
        }

        const claimCards = claims.map(claim => renderClaimCard(claim));
        claimContainer.innerHTML = claimCards.join('');

        lastClaimsLoad = now;
      } catch (e) {
        console.error('Load claims error:', e);
        claimContainer.innerHTML = '<p style="text-align: center; color: #f88;">Failed to load claims. Please try again.</p>';
      } finally {
        isLoadingClaims = false;
      }
    }

    async function checkSlotForBet(timestamp, token) {
      try {
        const [slot, bet] = await Promise.all([
          readContract(config, {
            address: CONTRACT_ADDRESS,
            abi: CONTRACT_ABI,
            functionName: 'slots',
            args: [BigInt(timestamp), token]
          }),
          readContract(config, {
            address: CONTRACT_ADDRESS,
            abi: CONTRACT_ABI,
            functionName: 'bets',
            args: [BigInt(timestamp), token, userAddress]
          })
        ]);

        if (Number(slot[0]) === 0 || Number(bet[0]) === 0) {
          return null;
        }

        const [startTime, endTime, targetTime, poolAbove, poolBelow, startPrice, targetPrice, settled] = slot;
        const [betAmount, betAbove, claimed] = bet;

        let didWin = false;
        let payout = 0;

        if (settled) {
          didWin = betAbove ? (targetPrice > startPrice) : (targetPrice < startPrice);
          
          if (didWin) {
            const userPool = betAbove ? poolAbove : poolBelow;
            const oppositePool = betAbove ? poolBelow : poolAbove;
            const totalPool = Number(userPool) + Number(oppositePool);
            payout = (Number(userPool) === 0) ? Number(betAmount) : 
                     (totalPool > 0 ? (Number(betAmount) * totalPool) / Number(userPool) : Number(betAmount));
          }
        }

        return {
          timestamp,
          token,
          slot,
          bet: { amount: betAmount, betAbove, claimed },
          didWin,
          settled,
          payout
        };
      } catch (e) {
        return null;
      }
    }

    function renderClaimCard(claim) {
      const { timestamp, token, slot, bet, didWin, settled, payout } = claim;
      const [startTime, endTime, targetTime, poolAbove, poolBelow, startPrice, targetPrice, isSettled] = slot;
      
      let statusClass = 'status-settled';
      let statusText = 'SETTLED';
      
      if (bet.claimed) {
        statusClass = 'status-claimed';
        statusText = 'CLAIMED ‚úì';
      } else if (didWin) {
        statusClass = 'status-won';
        statusText = 'WON! üéâ';
      } else if (settled) {
        statusClass = 'status-lost';
        statusText = 'LOST';
      } else {
        statusClass = 'status-closed';
        statusText = 'PENDING';
      }

      const date = new Date(timestamp * 1000);
      const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

      return `
        <div class="slot-card ${didWin && !bet.claimed ? 'claim-card' : ''}">
          <div class="slot-header">
            <div class="token-name">${token}</div>
            <div class="status-badge ${statusClass}">${statusText}</div>
          </div>

          <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
            ${timeStr} ‚Ä¢ Slot #${timestamp}
          </div>

          <div class="slot-info">
            <div class="info-item">
              <div class="info-label">Start Price</div>
              <div class="info-value">${(Number(startPrice) / 1e8).toFixed(2)}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Final Price</div>
              <div class="info-value">${settled ? (Number(targetPrice) / 1e8).toFixed(2) : 'Pending'}</div>
            </div>
          </div>

          <div class="user-bet-info">
            Your bet: ${(Number(bet.amount) / 1e18).toFixed(4)} ETH ${bet.betAbove ? 'üìà Above' : 'üìâ Below'}
          </div>

          ${didWin && !bet.claimed && settled ? `
            <div class="payout-info">
              <span class="payout-label">Your Winnings:</span>
              <span class="payout-value">${(payout / 1e18).toFixed(4)} ETH</span>
            </div>
            <button class="btn btn-claim" onclick="window.claimReward(${timestamp}, '${token}')">
              üéâ Claim ${(payout / 1e18).toFixed(4)} ETH
            </button>
          ` : ''}

          ${bet.claimed ? `
            <div style="text-align: center; color: #ffd166; font-size: 12px; padding: 8px; background: #0f0f0f; border-radius: 6px;">
              ‚úÖ Already claimed
            </div>
          ` : ''}

          ${!didWin && settled ? `
            <div style="text-align: center; color: #888; font-size: 12px; padding: 8px;">
              Price went ${bet.betAbove ? 'down' : 'up'} ‚Ä¢ Better luck next time!
            </div>
          ` : ''}

          ${!settled ? `
            <div style="text-align: center; color: #888; font-size: 12px; padding: 8px;">
              ‚è≥ Waiting for settlement...
            </div>
          ` : ''}
        </div>
      `;
    }

    let selectedBetAbove = true;
    let modalSymbol = '';
    let modalSlotStartTime = 0;

    const betAboveBtn = document.getElementById('betAboveBtn');
    const betBelowBtn = document.getElementById('betBelowBtn');
    const confirmBetBtn = document.getElementById('confirmBetBtn');
    const cancelBetBtn = document.getElementById('cancelBetBtn');
    const modalTitle = document.getElementById('modalTitle');

    window.openBetModal = (symbol, slotStartTime) => {
      modalSymbol = symbol;
      modalSlotStartTime = slotStartTime;
      selectedBetAbove = true;
      
      modalTitle.textContent = `Place Bet - ${symbol}`;
      betAboveBtn.classList.add('selected');
      betBelowBtn.classList.remove('selected');
      document.getElementById('betAmount').value = '';
      
      betModal.classList.add('show');
    };

    cancelBetBtn.onclick = () => {
      betModal.classList.remove('show');
    };

    betAboveBtn.onclick = () => {
      selectedBetAbove = true;
      betAboveBtn.classList.add('selected');
      betBelowBtn.classList.remove('selected');
    };

    betBelowBtn.onclick = () => {
      selectedBetAbove = false;
      betBelowBtn.classList.add('selected');
      betAboveBtn.classList.remove('selected');
    };

    confirmBetBtn.onclick = async () => {
      const amount = document.getElementById('betAmount').value;
      if (!amount || parseFloat(amount) <= 0) {
        showToast('‚ùå Enter valid bet amount');
        return;
      }

      try {
        betModal.classList.remove('show');
        
        const txHash = await writeContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'placeBet',
          args: [
            BigInt(modalSlotStartTime),
            modalSymbol,
            selectedBetAbove,
            BigInt(Math.floor(parseFloat(amount) * 1e18))
          ]
        });
        
        showToast(`‚è≥ Bet placed! <a target="_blank" href="https://sepolia.basescan.org/tx/${txHash}">view</a>`, 5000);
        
        setTimeout(() => {
          loadSlots();
          updateBalances();
        }, 3000);
      } catch (e) {
        console.error('Bet error:', e);
        showToast('‚ùå Bet failed: ' + (e.message || 'Unknown error'));
      }
    };

    window.claimReward = async (slotStartTime, symbol) => {
      try {
        const txHash = await writeContract(config, {
          address: CONTRACT_ADDRESS,
          abi: CONTRACT_ABI,
          functionName: 'claim',
          args: [BigInt(slotStartTime), symbol]
        });
        
        showToast(`üéâ Claim successful! <a target="_blank" href="https://sepolia.basescan.org/tx/${txHash}">view</a>`, 5000);
        
        setTimeout(() => {
          loadSlots();
          loadClaims(true); // Force reload after claim
          updateBalances();
        }, 3000);
      } catch (e) {
        console.error('Claim error:', e);
        showToast('‚ùå Claim failed: ' + (e.message || 'Unknown error'));
      }
    };

    // Setup event watchers
    let eventWatchersSetup = false;
    
    function setupEventWatchers() {
      if (eventWatchersSetup) return;
      eventWatchersSetup = true;

      watchContractEvent(config, {
        address: CONTRACT_ADDRESS,
        abi: CONTRACT_ABI,
        eventName: 'BetPlaced',
        onLogs: logs => {
          logs.forEach(log => {
            if (log.args?.user?.toLowerCase() === userAddress?.toLowerCase()) {
              const symbol = log.args?.symbol ?? '';
              const amount = log.args?.amount?.toString?.() ?? '';
              const above = log.args?.above ?? false;
              showToast(`‚úÖ Bet placed on ${symbol}: ${(Number(amount) / 1e18).toFixed(4)} ETH ${above ? 'üìà' : 'üìâ'}`);
              if (currentActiveTab === 'bet') loadSlots();
              updateBalances();
            }
          });
        }
      });

      watchContractEvent(config, {
        address: CONTRACT_ADDRESS,
        abi: CONTRACT_ABI,
        eventName: 'Claimed',
        onLogs: logs => {
          logs.forEach(log => {
            if (log.args?.user?.toLowerCase() === userAddress?.toLowerCase()) {
              const symbol = log.args?.symbol ?? '';
              const payout = log.args?.payout?.toString?.() ?? '';
              showToast(`üéâ Claimed ${symbol}: ${(Number(payout) / 1e18).toFixed(4)} ETH`);
              if (currentActiveTab === 'bet') loadSlots();
              if (currentActiveTab === 'claim') loadClaims(true);
              updateBalances();
            }
          });
        }
      });

      watchContractEvent(config, {
        address: CONTRACT_ADDRESS,
        abi: CONTRACT_ABI,
        eventName: 'SlotCreated',
        onLogs: logs => {
          if (currentActiveTab === 'bet') {
            logs.forEach(log => {
              const symbol = log.args?.symbol ?? '';
              if (symbol === 'BTC') {
                showToast(`üÜï New slot created!`);
                loadSlots();
              }
            });
          }
        }
      });

      watchContractEvent(config, {
        address: CONTRACT_ADDRESS,
        abi: CONTRACT_ABI,
        eventName: 'SlotSettled',
        onLogs: logs => {
          logs.forEach(log => {
            const symbol = log.args?.symbol ?? '';
            if (symbol === 'BTC') {
              showToast(`‚úÖ Slots settled! Check claims.`);
              if (currentActiveTab === 'bet') loadSlots();
              if (currentActiveTab === 'claim') loadClaims(true);
            }
          });
        }
      });
    }

    setTimeout(setupEventWatchers, 2000);

    // Smart refresh - faster on bet tab, slower on claim tab
    setInterval(() => {
      if (currentActiveTab === 'bet') {
        loadSlots(); // Fast refresh for live betting
      } else if (currentActiveTab === 'claim') {
        loadClaims(); // Respects 10s debounce to prevent constant reloading
      }
      updateBalances();
    }, 5000);

    betModal.onclick = (e) => {
      if (e.target === betModal) {
        betModal.classList.remove('show');
      }
    };

    console.log('üé≤ Crypto Betting DApp Initialized');
    console.log('üìç Contract:', CONTRACT_ADDRESS);
    console.log('üë§ User:', userAddress || 'Not connected');
    console.log('üí∞ Tokens: BTC, ETH');
    console.log('‚è±Ô∏è Betting: 2 min | Total: 3 min | Refresh: 5s');
  </script>
</body>
</html>